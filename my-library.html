<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ë„ì„œê´€ - ë‚˜ë§Œì˜ ë„ì„œê´€</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="main-header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <span class="logo-icon">ğŸ“š</span>
                <span class="logo-text">ë‚˜ë§Œì˜ ë„ì„œê´€</span>
            </a>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">í™ˆ</a>
                <a href="explore.html" class="nav-link">ë‘˜ëŸ¬ë³´ê¸°</a>
                <a href="my-library.html" class="nav-link active">ë‚´ ë„ì„œê´€</a>
                <a href="add-book.html" class="nav-link add-book-btn">+ ì±… ì¶”ê°€</a>
            </nav>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>
        </div>
    </header>

    <!-- ë„ì„œê´€ í—¤ë” -->
    <section class="my-library-header">
        <div class="library-avatar">ğŸ“š</div>
        <input type="text" 
               class="library-name-input" 
               id="libraryName" 
               value="ë‚˜ë§Œì˜ ë„ì„œê´€" 
               onchange="updateLibraryName(this)"
               placeholder="ë„ì„œê´€ ì´ë¦„">
        <p style="color:var(--text-secondary);margin-top:0.5rem;">ë„ì„œê´€ ì´ë¦„ì„ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”</p>
        
        <div class="library-stats">
            <div class="stat-card">
                <span class="stat-number">0</span>
                <span class="stat-label">ë“±ë¡ëœ ì±…</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">0</span>
                <span class="stat-label">ì´ ì¢‹ì•„ìš”</span>
            </div>
        </div>
    </section>

    <!-- ê³µìœ  ì„¹ì…˜ -->
    <section class="share-section" id="share">
        <h2>ğŸ”— ë„ì„œê´€ ê³µìœ í•˜ê¸°</h2>
        <p style="color:var(--text-secondary);margin-bottom:1rem;">
            QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ URLì„ ê³µìœ í•´ë³´ì„¸ìš”
        </p>
        
        <div class="qr-code" id="qrCode" style="display:flex;justify-content:center;margin:1.5rem 0;">
            <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            <div style="width:200px;height:200px;background:var(--border-color);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                <span style="color:var(--text-muted);">ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        
        <div style="display:flex;gap:0.5rem;justify-content:center;margin-bottom:1.5rem;">
            <button onclick="downloadQRCode()" class="btn btn-secondary btn-small">ğŸ“¥ QR ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="shareLibrary()" class="btn btn-secondary btn-small">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
        </div>
        
        <div class="share-url">
            <input type="text" id="shareUrl" readonly>
            <button onclick="copyShareUrl()">ë³µì‚¬</button>
        </div>
        
        <p class="form-hint" style="margin-top:1rem;">
            ğŸ’¡ GitHub Pagesì— ë°°í¬í•˜ë©´ ê³ ìœ  URLì´ ìƒì„±ë©ë‹ˆë‹¤
        </p>
    </section>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('books')">ğŸ“š ë‚´ ì±…</button>
        <button class="tab-btn" onclick="switchTab('liked')">â¤ï¸ ì¢‹ì•„ìš”</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š í†µê³„</button>
    </div>

    <!-- íƒ­ ë‚´ìš© -->
    <main style="max-width:1400px;margin:0 auto;">
        <!-- ë‚´ ì±… íƒ­ -->
        <div class="tab-content active" id="tab-books">
            <div class="section-header" style="padding:0 2rem;">
                <h2 class="section-title">ë‚´ê°€ ë“±ë¡í•œ ì±…</h2>
                <a href="add-book.html" class="btn btn-primary btn-small">+ ì±… ì¶”ê°€</a>
            </div>
            <div class="books-grid" id="myBooksGrid" style="padding:2rem;">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ì¢‹ì•„ìš” íƒ­ -->
        <div class="tab-content" id="tab-liked">
            <h2 class="section-title" style="padding:0 2rem;">ì¢‹ì•„ìš”í•œ ì±…</h2>
            <div class="books-grid" id="likedBooksGrid" style="padding:2rem;">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- í†µê³„ íƒ­ -->
        <div class="tab-content" id="tab-stats">
            <div style="padding:2rem;max-width:1000px;margin:0 auto;">
                <h2 class="section-title">ğŸ“Š ë„ì„œê´€ í†µê³„</h2>
                
                <!-- ì „ì²´ í†µê³„ ì¹´ë“œ -->
                <div class="form-card" style="margin-top:2rem;display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;">
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="totalBooksStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì „ì²´ ì±…</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="completedBooksStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì½ì€ ì±…</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="totalPagesStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì´ í˜ì´ì§€</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="avgRatingStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">í‰ê·  í‰ì </div>
                    </div>
                </div>
                
                <div class="form-card" style="margin-top:2rem;">
                    <h3>ë¶„ë¥˜ë³„ ì±… ìˆ˜</h3>
                    <div id="categoryStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <div class="form-card" style="margin-top:2rem;">
                    <h3>í‰ì  ë¶„í¬</h3>
                    <div id="ratingStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="form-card" style="margin-top:2rem;">
                    <h3>ë…ì„œ ìƒíƒœë³„ í†µê³„</h3>
                    <div id="readingStatusStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="main-footer">
        <div class="footer-bottom">
            <p>Â© 2024 ë‚˜ë§Œì˜ ë„ì„œê´€. GitHub Pagesë¡œ ìš´ì˜ë©ë‹ˆë‹¤.</p>
        </div>
    </footer>

    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script>
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // íƒ­ ë‚´ìš© í‘œì‹œ
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // íƒ­ë³„ ë‚´ìš© ë¡œë“œ
            if (tabName === 'liked') {
                renderLikedBooks();
            } else if (tabName === 'stats') {
                renderStats();
            }
        }

        // ì¢‹ì•„ìš”í•œ ì±… ë Œë”ë§
        function renderLikedBooks() {
            const container = document.getElementById('likedBooksGrid');
            const likedIds = getLikedBooks();
            const books = likedIds.map(id => getBookById(id)).filter(book => book);
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ’”</span>
                        <p>ì¢‹ì•„ìš”í•œ ì±…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <a href="explore.html" class="btn btn-primary">ì±… ë‘˜ëŸ¬ë³´ê¸°</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = books.map(book => createBookCard(book)).join('');
        }

        // í†µê³„ ë Œë”ë§
        function renderStats() {
            const stats = getStats();
            const books = getAllBooks();
            
            // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            const completedBooks = books.filter(b => b.readingStatus === 'completed').length;
            const totalPages = books.reduce((sum, b) => sum + (b.pages || 0), 0);
            const avgRating = books.length > 0 
                ? (books.reduce((sum, b) => sum + (b.rating || 0), 0) / books.length).toFixed(1)
                : 0;
            
            document.getElementById('totalBooksStat').textContent = stats.totalBooks;
            document.getElementById('completedBooksStat').textContent = completedBooks;
            document.getElementById('totalPagesStat').textContent = totalPages.toLocaleString();
            document.getElementById('avgRatingStat').textContent = avgRating;
            
            // ë¶„ë¥˜ë³„ í†µê³„
            const categoryStatsEl = document.getElementById('categoryStats');
            let categoryHtml = '';
            
            for (let i = 0; i <= 8; i++) {
                const cat = KDC_CATEGORIES[i];
                const count = stats.categoryCounts[i] || 0;
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                categoryHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${cat.icon} ${cat.name}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:var(--gradient-accent);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }
            categoryStatsEl.innerHTML = categoryHtml;
            
            // í‰ì  í†µê³„
            const ratingStatsEl = document.getElementById('ratingStats');
            const ratingCounts = [0, 0, 0, 0, 0, 0]; // 0~5ì 
            
            books.forEach(book => {
                const rating = book.rating || 0;
                ratingCounts[rating]++;
            });
            
            let ratingHtml = '';
            for (let i = 5; i >= 1; i--) {
                const count = ratingCounts[i];
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                ratingHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${'â­'.repeat(i)}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:linear-gradient(90deg, #ffd700, #ffb700);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }
            ratingStatsEl.innerHTML = ratingHtml;
            
            // ë…ì„œ ìƒíƒœë³„ í†µê³„
            const statusStatsEl = document.getElementById('readingStatusStats');
            const statusCounts = {
                not_started: books.filter(b => !b.readingStatus || b.readingStatus === 'not_started').length,
                reading: books.filter(b => b.readingStatus === 'reading').length,
                completed: books.filter(b => b.readingStatus === 'completed').length
            };
            
            let statusHtml = '';
            const statusLabels = {
                not_started: 'ğŸ“š ì•„ì§ ì•ˆ ì½ìŒ',
                reading: 'ğŸ“– ì½ëŠ” ì¤‘',
                completed: 'âœ… ì½ìŒ ì™„ë£Œ'
            };
            
            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                statusHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${statusLabels[status]}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:var(--gradient-accent);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });
            statusStatsEl.innerHTML = statusHtml;
        }

        // QR ì½”ë“œ ì¸ìŠ¤í„´ìŠ¤
        let qrCodeInstance = null;
        
        // QR ì½”ë“œ ìƒì„± (í˜ì´ì§€ ë¡œë“œ í›„)
        window.addEventListener('load', function() {
            generateLibraryQRCode();
        });
        
        function generateLibraryQRCode() {
            const qrContainer = document.getElementById('qrCode');
            const libraryInfo = getLibraryInfo();
            const libraryId = getLibraryId();
            
            // ë„ì„œê´€ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë“±ë¡ë¶€ ì—…ë°ì´íŠ¸
            registerLibraryInRegistry(libraryInfo.name);
            
            // ê³µìœ  ê°€ëŠ¥í•œ URL ìƒì„±
            const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
            const shareUrl = `${baseUrl}index.html?library=${libraryId}`;
            
            // í˜„ì¬ ë„ì„œê´€ ë°ì´í„°ë¥¼ ê³µìœ ìš©ìœ¼ë¡œ ì €ì¥
            const books = getAllBooks();
            const stats = getStats();
            const sharedData = {
                libraryInfo: {
                    ...libraryInfo,
                    bookCount: stats.totalBooks,
                    totalLikes: stats.totalLikes
                },
                books,
                createdAt: Date.now()
            };
            localStorage.setItem(`shared_library_${libraryId}`, JSON.stringify(sharedData));
            
            // URL ì…ë ¥ë€ ì—…ë°ì´íŠ¸
            document.getElementById('shareUrl').value = shareUrl;
            
            if (qrContainer && typeof QRCode !== 'undefined') {
                // ê¸°ì¡´ QR ì½”ë“œ ì œê±°
                qrContainer.innerHTML = '';
                
                // ìƒˆ QR ì½”ë“œ ìƒì„±
                qrCodeInstance = new QRCode(qrContainer, {
                    text: shareUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#2c2c2c',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // ìŠ¤íƒ€ì¼ ì ìš©
                setTimeout(() => {
                    const img = qrContainer.querySelector('img');
                    const canvas = qrContainer.querySelector('canvas');
                    if (img) img.style.borderRadius = '12px';
                    if (canvas) canvas.style.borderRadius = '12px';
                }, 100);
            } else {
                qrContainer.innerHTML = `
                    <div style="width:200px;height:200px;background:var(--accent-light);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0.5rem;">
                        <span style="font-size:3rem;">ğŸ“±</span>
                        <span style="color:var(--text-secondary);font-size:0.9rem;">QR ì½”ë“œ</span>
                    </div>
                `;
            }
        }
        
        // QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ
        function downloadQRCode() {
            const qrContainer = document.getElementById('qrCode');
            const canvas = qrContainer.querySelector('canvas');
            const img = qrContainer.querySelector('img');
            
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'ë‚´_ë„ì„œê´€_QR.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else if (img) {
                // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ë¡œ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = 'ë‚´_ë„ì„œê´€_QR.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                showToast('QR ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }
        
        // ë„ì„œê´€ ê³µìœ  (Web Share API)
        async function shareLibrary() {
            const libraryInfo = getLibraryInfo();
            const shareUrl = window.location.origin + window.location.pathname;
            
            const shareData = {
                title: libraryInfo.name,
                text: `ğŸ“š ${libraryInfo.name}ì„(ë¥¼) ë°©ë¬¸í•´ë³´ì„¸ìš”!`,
                url: shareUrl
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    showToast('ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    // Web Share API ë¯¸ì§€ì› ì‹œ í´ë¦½ë³´ë“œ ë³µì‚¬
                    await navigator.clipboard.writeText(shareUrl);
                    showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„
                    try {
                        await navigator.clipboard.writeText(shareUrl);
                        showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } catch {
                        showToast('ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                    }
                }
            }
        }
    </script>
</body>
</html>

