<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ë„ì„œê´€ - ë‚˜ë§Œì˜ ë„ì„œê´€</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="main-header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <span class="logo-icon">ğŸ“š</span>
                <span class="logo-text">ë‚˜ë§Œì˜ ë„ì„œê´€</span>
            </a>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">í™ˆ</a>
                <a href="explore.html" class="nav-link">ë‘˜ëŸ¬ë³´ê¸°</a>
                <a href="my-library.html" class="nav-link active">ë‚´ ë„ì„œê´€</a>
                <a href="add-book.html" class="nav-link add-book-btn">+ ì±… ì¶”ê°€</a>
            </nav>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>
        </div>
    </header>

    <!-- ë„ì„œê´€ í—¤ë” -->
    <section class="my-library-header">
        <div class="library-avatar">ğŸ“š</div>
        <input type="text" 
               class="library-name-input" 
               id="libraryName" 
               value="ë‚˜ë§Œì˜ ë„ì„œê´€" 
               onchange="updateLibraryName(this)"
               onblur="updateLibraryName(this)"
               placeholder="ë„ì„œê´€ ì´ë¦„">
        <p style="color:var(--text-secondary);margin-top:0.5rem;">
            ë„ì„œê´€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. ë‹¤ë¥¸ ì‚¬ëŒì´ ì´ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <div style="margin-top:0.5rem;padding:0.8rem;background:var(--accent-light);border-radius:8px;font-size:0.85rem;color:var(--text-secondary);">
            ğŸ’¡ <strong>íŒ:</strong> ë…íŠ¹í•˜ê³  ê¸°ì–µí•˜ê¸° ì‰¬ìš´ ì´ë¦„ì„ ì§€ìœ¼ë©´ ì¹œêµ¬ë“¤ì´ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆì–´ìš”!
        </div>
        
        <!-- ë„ì„œê´€ ê³µê°œ ì„¤ì • -->
        <div style="margin-top:1.5rem;padding:1.5rem;background:var(--bg-card);border-radius:16px;border:2px solid var(--border-color);">
            <h3 style="margin-bottom:1rem;font-size:1.1rem;">ğŸ”’ ë„ì„œê´€ ê³µê°œ ì„¤ì •</h3>
            <select id="libraryVisibility" class="form-select" onchange="updateLibraryVisibility(this.value)">
                <option value="public">ğŸŒ ê³µê°œ - ëª¨ë“  ì±…ê³¼ ì •ë³´ ê³µê°œ</option>
                <option value="partial">ğŸ”“ ì¼ë¶€ ê³µê°œ - ì½ê³  ìˆëŠ” ì±…ë§Œ ê³µê°œ</option>
                <option value="private">ğŸ”’ ë¹„ê³µê°œ - ê¸°ë³¸ ì •ë³´ë§Œ ê³µê°œ</option>
            </select>
            <div style="margin-top:1rem;font-size:0.85rem;color:var(--text-secondary);line-height:1.6;">
                <p><strong>ğŸŒ ê³µê°œ:</strong> ëª¨ë“  ì±…ê³¼ ì •ë³´ê°€ ê³µê°œë©ë‹ˆë‹¤</p>
                <p><strong>ğŸ”“ ì¼ë¶€ ê³µê°œ:</strong> ì½ê³  ìˆëŠ” ì±…(reading/completed)ë§Œ ê³µê°œë©ë‹ˆë‹¤</p>
                <p><strong>ğŸ”’ ë¹„ê³µê°œ:</strong> ë„ì„œê´€ ì´ë¦„ê³¼ ê¸°ë³¸ í†µê³„ë§Œ ê³µê°œë©ë‹ˆë‹¤</p>
            </div>
            <div style="margin-top:1rem;padding:0.8rem;background:var(--bg-primary);border-radius:8px;font-size:0.85rem;">
                <strong>ê¸°ë³¸ ì±… ê³µê°œ ì„¤ì •:</strong>
                <select id="defaultBookVisibility" class="form-select" style="margin-top:0.5rem;" onchange="updateDefaultBookVisibility(this.value)">
                    <option value="public">ê³µê°œ</option>
                    <option value="partial">ì¼ë¶€ ê³µê°œ</option>
                    <option value="private">ë¹„ê³µê°œ</option>
                </select>
                <p style="margin-top:0.5rem;color:var(--text-secondary);">ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ì±…ì˜ ê¸°ë³¸ ê³µê°œ ì„¤ì •ì…ë‹ˆë‹¤</p>
            </div>
        </div>
        
        <div class="library-stats">
            <div class="stat-card">
                <span class="stat-number">0</span>
                <span class="stat-label">ë“±ë¡ëœ ì±…</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">0</span>
                <span class="stat-label">ì´ ì¢‹ì•„ìš”</span>
            </div>
        </div>
    </section>

    <!-- ê³µìœ  ì„¹ì…˜ -->
    <section class="share-section" id="share">
        <h2>ğŸ”— ë„ì„œê´€ ê³µìœ í•˜ê¸°</h2>
        <p style="color:var(--text-secondary);margin-bottom:1rem;">
            QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ URLì„ ê³µìœ í•´ë³´ì„¸ìš”
        </p>
        
        <div class="qr-code" id="qrCode" style="display:flex;justify-content:center;margin:1.5rem 0;">
            <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            <div style="width:200px;height:200px;background:var(--border-color);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                <span style="color:var(--text-muted);">ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        
        <div style="display:flex;gap:0.5rem;justify-content:center;margin-bottom:1.5rem;flex-wrap:wrap;">
            <button onclick="downloadQRCode()" class="btn btn-secondary btn-small">ğŸ“¥ QR ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="shareLibrary()" class="btn btn-secondary btn-small">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
            <button onclick="exportLibrary()" class="btn btn-primary btn-small">ğŸ’¾ ë„ì„œê´€ ë‚´ë³´ë‚´ê¸°</button>
            <button onclick="document.getElementById('importFile').click()" class="btn btn-primary btn-small">ğŸ“‚ ë„ì„œê´€ ê°€ì ¸ì˜¤ê¸°</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importLibrary(event)">
        </div>
        
        <div class="share-url">
            <input type="text" id="shareUrl" readonly>
            <button onclick="copyShareUrl()">ë³µì‚¬</button>
        </div>
        
        <div style="margin-top:1.5rem;padding:1rem;background:var(--accent-light);border-radius:12px;">
            <h3 style="font-size:1rem;margin-bottom:0.5rem;">ğŸ“‹ ê³µìœ  ë°©ë²•</h3>
            <ol style="margin:0;padding-left:1.2rem;color:var(--text-secondary);font-size:0.9rem;line-height:1.8;">
                <li><strong>ë„ì„œê´€ ë‚´ë³´ë‚´ê¸°</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</li>
                <li>ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬ (ì´ë©”ì¼, ë©”ì‹ ì € ë“±)</li>
                <li>ë‹¤ë¥¸ ì‚¬ìš©ìê°€ <strong>ë„ì„œê´€ ê°€ì ¸ì˜¤ê¸°</strong> ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ</li>
                <li>ê³µê°œ ì„¤ì •ì— ë”°ë¼ ì •ë³´ê°€ ìë™ìœ¼ë¡œ í•„í„°ë§ë©ë‹ˆë‹¤</li>
            </ol>
        </div>
        
        <p class="form-hint" style="margin-top:1rem;">
            ğŸ’¡ GitHub Pagesì— ë°°í¬í•˜ë©´ ê³ ìœ  URLì´ ìƒì„±ë©ë‹ˆë‹¤
        </p>
    </section>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('books')">ğŸ“š ë‚´ ì±…</button>
        <button class="tab-btn" onclick="switchTab('liked')">â¤ï¸ ì¢‹ì•„ìš”</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š í†µê³„</button>
    </div>

    <!-- íƒ­ ë‚´ìš© -->
    <main style="max-width:1400px;margin:0 auto;">
        <!-- ë‚´ ì±… íƒ­ -->
        <div class="tab-content active" id="tab-books">
            <div class="section-header" style="padding:0 2rem;">
                <h2 class="section-title">ë‚´ê°€ ë“±ë¡í•œ ì±…</h2>
                <a href="add-book.html" class="btn btn-primary btn-small">+ ì±… ì¶”ê°€</a>
            </div>
            <div class="books-grid" id="myBooksGrid" style="padding:2rem;">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ì¢‹ì•„ìš” íƒ­ -->
        <div class="tab-content" id="tab-liked">
            <h2 class="section-title" style="padding:0 2rem;">ì¢‹ì•„ìš”í•œ ì±…</h2>
            <div class="books-grid" id="likedBooksGrid" style="padding:2rem;">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- í†µê³„ íƒ­ -->
        <div class="tab-content" id="tab-stats">
            <div style="padding:2rem;max-width:1000px;margin:0 auto;">
                <h2 class="section-title">ğŸ“Š ë„ì„œê´€ í†µê³„</h2>
                
                <!-- ì „ì²´ í†µê³„ ì¹´ë“œ -->
                <div class="form-card" style="margin-top:2rem;display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;">
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="totalBooksStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì „ì²´ ì±…</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="completedBooksStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì½ì€ ì±…</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="totalPagesStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">ì´ í˜ì´ì§€</div>
                    </div>
                    <div style="text-align:center;padding:1.5rem;background:var(--accent-light);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent-primary);" id="avgRatingStat">0</div>
                        <div style="color:var(--text-secondary);margin-top:0.5rem;">í‰ê·  í‰ì </div>
                    </div>
                </div>
                
                <div class="form-card" style="margin-top:2rem;">
                    <h3>ë¶„ë¥˜ë³„ ì±… ìˆ˜</h3>
                    <div id="categoryStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <div class="form-card" style="margin-top:2rem;">
                    <h3>í‰ì  ë¶„í¬</h3>
                    <div id="ratingStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="form-card" style="margin-top:2rem;">
                    <h3>ë…ì„œ ìƒíƒœë³„ í†µê³„</h3>
                    <div id="readingStatusStats" style="margin-top:1.5rem;">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="main-footer">
        <div class="footer-bottom">
            <p>Â© 2024 ë‚˜ë§Œì˜ ë„ì„œê´€. GitHub Pagesë¡œ ìš´ì˜ë©ë‹ˆë‹¤.</p>
        </div>
    </footer>

    <!-- Firebase ì„¤ì • (ì„ íƒì‚¬í•­) -->
    <script src="firebase-config.js" defer></script>
    
    <!-- ìŠ¤í† ë¦¬ì§€ (Firebase ìš°ì„ , ì—†ìœ¼ë©´ localStorage) -->
    <script src="js/storage.js"></script>
    <script src="js/firebase-storage.js" defer></script>
    <script src="js/app.js"></script>
    <script>
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // íƒ­ ë‚´ìš© í‘œì‹œ
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // íƒ­ë³„ ë‚´ìš© ë¡œë“œ
            if (tabName === 'liked') {
                renderLikedBooks();
            } else if (tabName === 'stats') {
                renderStats();
            }
        }

        // ì¢‹ì•„ìš”í•œ ì±… ë Œë”ë§
        function renderLikedBooks() {
            const container = document.getElementById('likedBooksGrid');
            const likedIds = getLikedBooks();
            const books = likedIds.map(id => getBookById(id)).filter(book => book);
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ’”</span>
                        <p>ì¢‹ì•„ìš”í•œ ì±…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <a href="explore.html" class="btn btn-primary">ì±… ë‘˜ëŸ¬ë³´ê¸°</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = books.map(book => createBookCard(book)).join('');
        }

        // í†µê³„ ë Œë”ë§
        function renderStats() {
            const stats = getStats();
            const books = getAllBooks();
            
            // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            const completedBooks = books.filter(b => b.readingStatus === 'completed').length;
            const totalPages = books.reduce((sum, b) => sum + (b.pages || 0), 0);
            const avgRating = books.length > 0 
                ? (books.reduce((sum, b) => sum + (b.rating || 0), 0) / books.length).toFixed(1)
                : 0;
            
            document.getElementById('totalBooksStat').textContent = stats.totalBooks;
            document.getElementById('completedBooksStat').textContent = completedBooks;
            document.getElementById('totalPagesStat').textContent = totalPages.toLocaleString();
            document.getElementById('avgRatingStat').textContent = avgRating;
            
            // ë¶„ë¥˜ë³„ í†µê³„
            const categoryStatsEl = document.getElementById('categoryStats');
            let categoryHtml = '';
            
            for (let i = 0; i <= 8; i++) {
                const cat = KDC_CATEGORIES[i];
                const count = stats.categoryCounts[i] || 0;
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                categoryHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${cat.icon} ${cat.name}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:var(--gradient-accent);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }
            categoryStatsEl.innerHTML = categoryHtml;
            
            // í‰ì  í†µê³„
            const ratingStatsEl = document.getElementById('ratingStats');
            const ratingCounts = [0, 0, 0, 0, 0, 0]; // 0~5ì 
            
            books.forEach(book => {
                const rating = book.rating || 0;
                ratingCounts[rating]++;
            });
            
            let ratingHtml = '';
            for (let i = 5; i >= 1; i--) {
                const count = ratingCounts[i];
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                ratingHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${'â­'.repeat(i)}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:linear-gradient(90deg, #ffd700, #ffb700);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }
            ratingStatsEl.innerHTML = ratingHtml;
            
            // ë…ì„œ ìƒíƒœë³„ í†µê³„
            const statusStatsEl = document.getElementById('readingStatusStats');
            const statusCounts = {
                not_started: books.filter(b => !b.readingStatus || b.readingStatus === 'not_started').length,
                reading: books.filter(b => b.readingStatus === 'reading').length,
                completed: books.filter(b => b.readingStatus === 'completed').length
            };
            
            let statusHtml = '';
            const statusLabels = {
                not_started: 'ğŸ“š ì•„ì§ ì•ˆ ì½ìŒ',
                reading: 'ğŸ“– ì½ëŠ” ì¤‘',
                completed: 'âœ… ì½ìŒ ì™„ë£Œ'
            };
            
            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const percentage = stats.totalBooks > 0 ? (count / stats.totalBooks * 100) : 0;
                
                statusHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                            <span>${statusLabels[status]}</span>
                            <span>${count}ê¶Œ</span>
                        </div>
                        <div style="height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:var(--gradient-accent);border-radius:4px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });
            statusStatsEl.innerHTML = statusHtml;
        }

        // QR ì½”ë“œ ì¸ìŠ¤í„´ìŠ¤
        let qrCodeInstance = null;
        
        // QR ì½”ë“œ ìƒì„± (í˜ì´ì§€ ë¡œë“œ í›„)
        window.addEventListener('load', function() {
            generateLibraryQRCode();
        });
        
        function generateLibraryQRCode() {
            const qrContainer = document.getElementById('qrCode');
            const libraryInfo = getLibraryInfo();
            const libraryId = getLibraryId();
            
            // ë„ì„œê´€ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë“±ë¡ë¶€ ì—…ë°ì´íŠ¸
            registerLibraryInRegistry(libraryInfo.name);
            
            // ê³µìœ  ê°€ëŠ¥í•œ URL ìƒì„±
            const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
            const shareUrl = `${baseUrl}index.html?library=${libraryId}`;
            
            // í˜„ì¬ ë„ì„œê´€ ë°ì´í„°ë¥¼ ê³µìœ ìš©ìœ¼ë¡œ ì €ì¥
            // Firebaseë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ìë™ìœ¼ë¡œ ë™ê¸°í™”ë˜ë¯€ë¡œ localStorageëŠ” ë°±ì—…ìš©
            (async function() {
                const books = await getAllBooks();
                const stats = await getStats();
                const sharedData = {
                    libraryInfo: {
                        ...libraryInfo,
                        visibility: libraryInfo.visibility || 'public', // ê³µê°œ ì„¤ì • í¬í•¨
                        bookCount: stats.totalBooks,
                        totalLikes: stats.totalLikes
                    },
                    books: books.map(book => ({
                        ...book,
                        visibility: book.visibility || 'public' // ê° ì±…ì˜ ê³µê°œ ì„¤ì • í¬í•¨
                    })),
                    createdAt: Date.now()
                };
                // localStorage ë°±ì—… (Firebaseê°€ ì—†ì„ ë•Œ ì‚¬ìš©)
                localStorage.setItem(`shared_library_${libraryId}`, JSON.stringify(sharedData));
                
                // Firebaseì— ë“±ë¡ë¶€ ì—…ë°ì´íŠ¸
                if (typeof registerLibraryInRegistry === 'function') {
                    await registerLibraryInRegistry(libraryInfo.name);
                }
            })();
            
            // URL ì…ë ¥ë€ ì—…ë°ì´íŠ¸
            document.getElementById('shareUrl').value = shareUrl;
            
            if (qrContainer && typeof QRCode !== 'undefined') {
                // ê¸°ì¡´ QR ì½”ë“œ ì œê±°
                qrContainer.innerHTML = '';
                
                // ìƒˆ QR ì½”ë“œ ìƒì„±
                qrCodeInstance = new QRCode(qrContainer, {
                    text: shareUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#2c2c2c',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // ìŠ¤íƒ€ì¼ ì ìš©
                setTimeout(() => {
                    const img = qrContainer.querySelector('img');
                    const canvas = qrContainer.querySelector('canvas');
                    if (img) img.style.borderRadius = '12px';
                    if (canvas) canvas.style.borderRadius = '12px';
                }, 100);
            } else {
                qrContainer.innerHTML = `
                    <div style="width:200px;height:200px;background:var(--accent-light);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0.5rem;">
                        <span style="font-size:3rem;">ğŸ“±</span>
                        <span style="color:var(--text-secondary);font-size:0.9rem;">QR ì½”ë“œ</span>
                    </div>
                `;
            }
        }
        
        // QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ
        function downloadQRCode() {
            const qrContainer = document.getElementById('qrCode');
            const canvas = qrContainer.querySelector('canvas');
            const img = qrContainer.querySelector('img');
            
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'ë‚´_ë„ì„œê´€_QR.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else if (img) {
                // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ë¡œ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = 'ë‚´_ë„ì„œê´€_QR.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                showToast('QR ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }
        
        // ë„ì„œê´€ ê³µìœ  (Web Share API)
        async function shareLibrary() {
            const libraryInfo = getLibraryInfo();
            const shareUrl = window.location.origin + window.location.pathname;
            
            const shareData = {
                title: libraryInfo.name,
                text: `ğŸ“š ${libraryInfo.name}ì„(ë¥¼) ë°©ë¬¸í•´ë³´ì„¸ìš”!`,
                url: shareUrl
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    showToast('ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    // Web Share API ë¯¸ì§€ì› ì‹œ í´ë¦½ë³´ë“œ ë³µì‚¬
                    await navigator.clipboard.writeText(shareUrl);
                    showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„
                    try {
                        await navigator.clipboard.writeText(shareUrl);
                        showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } catch {
                        showToast('ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                    }
                }
            }
        }
        
        // ë„ì„œê´€ ë‚´ë³´ë‚´ê¸° (JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
        function exportLibrary() {
            const libraryInfo = getLibraryInfo();
            const books = getAllBooks();
            const stats = getStats();
            
            // ê³µê°œ ì„¤ì •ì— ë”°ë¼ í•„í„°ë§ëœ ë°ì´í„° ìƒì„±
            const libraryVisibility = libraryInfo.visibility || 'public';
            let filteredBooks = books;
            
            if (libraryVisibility === 'partial') {
                // ì¼ë¶€ ê³µê°œ: ì½ê³  ìˆëŠ” ì±…ë§Œ
                filteredBooks = books.filter(book => 
                    book.readingStatus === 'reading' || book.readingStatus === 'completed'
                );
            } else if (libraryVisibility === 'private') {
                // ë¹„ê³µê°œ: ë¹ˆ ë°°ì—´
                filteredBooks = [];
            }
            
            // ê° ì±…ì˜ ê³µê°œ ì„¤ì •ë„ ì ìš©
            filteredBooks = filteredBooks.map(book => {
                const bookVisibility = book.visibility || 'public';
                if (bookVisibility === 'private') {
                    // ë¹„ê³µê°œ ì±…: ê¸°ë³¸ ì •ë³´ë§Œ
                    return {
                        id: book.id,
                        title: book.title,
                        author: book.author,
                        publisher: book.publisher,
                        image: book.image,
                        category: book.category,
                        categoryId: book.categoryId,
                        visibility: bookVisibility
                    };
                } else if (bookVisibility === 'partial') {
                    // ì¼ë¶€ ê³µê°œ: ìš”ì•½, ëª©ì°¨, ìƒì„¸ ê¸°ë¡ ìˆ¨ê¹€
                    return {
                        ...book,
                        summary: '',
                        tableOfContents: [],
                        readingStartDate: null,
                        readingEndDate: null,
                        pages: null
                    };
                }
                return book;
            });
            
            const exportData = {
                version: '1.0',
                libraryInfo: {
                    name: libraryInfo.name,
                    description: libraryInfo.description || '',
                    avatar: libraryInfo.avatar || 'ğŸ“š',
                    visibility: libraryVisibility,
                    bookCount: filteredBooks.length,
                    totalLikes: stats.totalLikes,
                    exportedAt: new Date().toISOString()
                },
                books: filteredBooks
            };
            
            // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${libraryInfo.name}_ë„ì„œê´€_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('ë„ì„œê´€ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
        }
        
        // ë„ì„œê´€ ê°€ì ¸ì˜¤ê¸° (JSON íŒŒì¼ ì—…ë¡œë“œ)
        function importLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showToast('JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.libraryInfo || !importData.books) {
                        showToast('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤', 'error');
                        return;
                    }
                    
                    // í™•ì¸ ë©”ì‹œì§€
                    const confirmMsg = `"${importData.libraryInfo.name}" ë„ì„œê´€ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                                     `ì±… ${importData.books.length}ê¶Œì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n` +
                                     `âš ï¸ í˜„ì¬ ë„ì„œê´€ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    // ê³µìœ  ëª¨ë“œë¡œ í‘œì‹œ
                    const libraryId = `imported_${Date.now()}`;
                    const sharedData = {
                        libraryInfo: importData.libraryInfo,
                        books: importData.books,
                        createdAt: Date.now()
                    };
                    
                    // ì„ì‹œë¡œ ê³µìœ  ë°ì´í„° ì €ì¥
                    localStorage.setItem(`shared_library_${libraryId}`, JSON.stringify(sharedData));
                    
                    // ê³µìœ  ëª¨ë“œë¡œ ì´ë™
                    window.location.href = `index.html?library=${libraryId}`;
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    showToast('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }
    </script>
</body>
</html>

